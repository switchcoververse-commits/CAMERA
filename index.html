<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Scanner Pro V9.0 - Hilo de Ariadna</title>
<style>
    body { margin:0; background:#000; color:white; font-family:-apple-system, sans-serif; overflow:hidden; text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; }
    .top-bar { width:100%; display:flex; justify-content:space-between; padding:10px; box-sizing:border-box; }
    .top-bar button { background:none; border:none; color:#fff; font-size:24px; cursor:pointer; }
    .status { width:90%; margin:10px auto; background:#222; border-radius:10px; padding:10px; font-weight:600; font-size:18px; }
    .viewport { position:relative; width:90vw; height:50vh; background:#111; margin-top:10px; overflow:hidden; border-radius:15px; }
    video { width:100%; height:100%; object-fit:cover; }
    .scanner-frame { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:75%; height:55%; border:4px solid rgba(0,255,0,0.6); border-radius:15px; pointer-events:none; transition: all 0.3s ease; }
    .help { margin-top:10px; display:flex; align-items:center; justify-content:center; font-size:14px; color:#aaa; }
    .help span { margin-left:5px; }
    .controls { width:100%; display:flex; justify-content:center; align-items:center; margin-top:20px; position:relative; }
    .shutter-btn { width:90px; height:90px; background:#555; border-radius:50%; border:4px solid #333; cursor:pointer; }
    #flash-btn { position:absolute; right:20px; bottom:0; font-size:24px; cursor:pointer; }
    #photo-list { display:flex; overflow-x:auto; margin-top:15px; padding:5px; }
    .photo-item { position:relative; margin-right:10px; }
    .photo-item img { width:80px; height:80px; object-fit:cover; border-radius:8px; }
    .delete-btn { position:absolute; top:2px; right:2px; background:#f33; border:none; border-radius:50%; width:20px; height:20px; color:#fff; font-size:14px; cursor:pointer; }
    #loading { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.98); z-index:1000; flex-direction:column; align-items:center; justify-content:center; }
    .spinner { width:60px; height:60px; border:6px solid #222; border-top:6px solid #00ff00; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin {0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);}}
</style>
</head>
<body>

<div class="top-bar">
    <button id="back-btn">&lt;</button>
    <button id="close-btn">X</button>
</div>

<div class="status" id="status-text">Cargando cámara...</div>

<div class="viewport">
    <video id="video" autoplay playsinline muted></video>
    <div class="scanner-frame" id="frame"></div>
</div>

<div class="help">
    <img src="info-icon.png" width="16" height="16" alt="info">
    <span>Consejos para hacer la foto</span>
</div>

<div class="controls">
    <div class="shutter-btn" id="capture"></div>
    <div id="flash-btn">⚡</div>
</div>

<div id="photo-list"></div>

<div id="loading">
    <div class="spinner"></div>
    <p style="margin-top:25px; font-weight:900; color:#00ff00; font-size:20px;">ENVIANDO...</p>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/YOUR_WEBAPP_ID/exec";
const GOOGLE_FORM = "https://docs.google.com/forms/d/e/YOUR_FORM_ID/viewform";
const MAX_PHOTOS = 30;

let photos = [];
let isLevelValid = false;
let video = document.getElementById('video');
let frame = document.getElementById('frame');
let statusText = document.getElementById('status-text');
let photoList = document.getElementById('photo-list');
let canvas = document.getElementById('canvas');

navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
.then(s => { video.srcObject = s; statusText.innerText="Cámara lista."; })
.catch(err => { alert("Se requiere acceso a cámara."); });

function playCameraSound(){
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.frequency.setValueAtTime(600,audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(10,audioCtx.currentTime+0.1);
    gain.gain.setValueAtTime(0.4,audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.1);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime+0.1);
}

// CAPTURA FOTO
document.getElementById('capture').onclick = () => {
    if(photos.length>=MAX_PHOTOS){ alert("Máximo "+MAX_PHOTOS+" fotos por pedido."); return; }
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video,0,0);
    
    // Validación de blanco para color
    let imgData = canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height);
    let data = imgData.data;
    let whitePixels=0;
    for(let i=0;i<data.length;i+=4){
        if(data[i]>200 && data[i+1]>200 && data[i+2]>200) whitePixels++;
    }
    if(whitePixels<1000){ alert("Asegúrese de capturar bien el blanco del dispositivo."); return; }

    photos.push(canvas.toDataURL('image/jpeg',0.45));
    renderPhotoList();
    playCameraSound();
};

function renderPhotoList(){
    photoList.innerHTML="";
    photos.forEach((p,i)=>{
        let div = document.createElement('div');
        div.className="photo-item";
        let img = document.createElement('img');
        img.src=p;
        let del = document.createElement('button');
        del.className="delete-btn";
        del.innerText="X";
        del.onclick=()=>{ photos.splice(i,1); renderPhotoList(); };
        div.appendChild(img); div.appendChild(del);
        photoList.appendChild(div);
    });
}

// FINALIZAR PEDIDO
function finishOrder(orderID){
    if(photos.length===0){ alert("Capture al menos una foto."); return; }
    document.getElementById('loading').style.display='flex';
    fetch(WEBAPP_URL,{
        method:'POST',
        mode:'no-cors',
        body: JSON.stringify({ userName: orderID, photos: photos })
    }).then(()=>{ window.location.href = GOOGLE_FORM + "?usp=pp_url&entry.ID_AQUI=" + orderID; });
}

// BOTONES SUPERIORES
document.getElementById('back-btn').onclick = ()=>{ window.history.back(); };
document.getElementById('close-btn').onclick = ()=>{ window.close(); };
</script>

</body>
</html>
