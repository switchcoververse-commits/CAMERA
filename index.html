<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Scanner Pro V8.0 - Hilo de Ariadna</title>
<style>
    body { margin:0; background:#000; color:white; font-family:-apple-system, sans-serif; overflow:hidden; text-align:center; }
    .viewport { position:relative; width:100vw; height:70vh; background:#111; overflow:hidden; }
    video { width:100%; height:100%; object-fit:cover; }
    #flash { position:absolute; top:0; left:0; width:100%; height:100%; background:white; opacity:0; z-index:50; pointer-events:none; }
    .scanner-frame { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:75%; height:55%; border:4px solid rgba(255,0,0,0.6); border-radius:25px; z-index:10; pointer-events:none; transition: all 0.3s ease; }
    #start-overlay { position:absolute; top:0; left:0; width:100%; height:100%; z-index:100; background: rgba(0,0,0,0.85); display:flex; flex-direction:column; align-items:center; justify-content:center; backdrop-filter:blur(10px); }
    .btn-start { background:#00d4ff; color:#000; padding:25px 50px; border-radius:60px; font-weight:900; font-size:22px; border:none; box-shadow:0 0 30px rgba(0,212,255,0.5); text-transform:uppercase; cursor:pointer; }
    #central-msg { position:absolute; top:45%; left:50%; transform:translate(-50%, -50%); width:90%; pointer-events:none; z-index:60; text-align:center; }
    .status-text { font-weight:900; font-size:32px; color:#00ff00; text-shadow:0 0 20px rgba(0,0,0,1); opacity:0; transition:opacity 0.8s ease; }
    .invalid-text { font-weight:900; font-size:28px; color:#ff3333; text-shadow:0 0 20px rgba(0,0,0,1); opacity:0; transition:opacity 0.8s ease; }
    .controls { height:30vh; display:flex; flex-direction:column; align-items:center; justify-content:space-evenly; background:#000; }
    .shutter-btn { width:90px; height:90px; background:white; border-radius:50%; border:8px solid #333; cursor:pointer; }
    .btn-finish { display:none; background:#00ff00; color:#000; border:none; padding:18px 40px; font-weight:900; border-radius:50px; font-size:16px; width:85%; animation:pulse 2s infinite; cursor:pointer; }
    @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }
    #loading { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.98); z-index:1000; flex-direction:column; align-items:center; justify-content:center; }
    .spinner { width:60px; height:60px; border:6px solid #222; border-top:6px solid #00ff00; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin {0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);}}
</style>
</head>
<body>

<div id="loading">
    <div class="spinner"></div>
    <p style="margin-top:25px; font-weight:900; color:#00ff00; font-size:20px;">SENDING TO DRIVE...</p>
</div>

<div id="flash"></div>

<div id="start-overlay">
    <h2 id="order-display" style="margin-bottom:10px; letter-spacing:2px;">SCANNER READY</h2>
    <p id="order-number" style="color:#00d4ff; font-weight:bold; margin-bottom:30px;"></p>
    <button class="btn-start" id="init-btn">START SCANNER</button>
</div>

<div class="viewport">
    <video id="video" autoplay playsinline muted></video>
    <div class="scanner-frame" id="frame"></div>
    <div id="central-msg">
        <div id="status-text" class="status-text">DEVICE SAVED.<br>NEXT ONE!</div>
        <div id="invalid-text" class="invalid-text" style="display:none;">INVALID PHOTO<br>PLEASE ALIGN DEVICE</div>
    </div>
</div>

<div class="controls">
    <div class="shutter-btn" id="capture"></div>
    <button id="finish" class="btn-finish">DONE: FINISH ORDER</button>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
    // ============================================
    // CONFIGURACIÓN
    // ============================================
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz0ZGbgeTsKLE4-wUG9sGr7tb2kxPopysqhnkeEloyaL2OShwhuivW4tcy7IlFR5FpX4Q/exec";
    const GOOGLE_FORM = "https://docs.google.com/forms/d/e/1FAIpQLScbU0wmhZIKDQAuYEoptN-RsS7f2FSGsTVoZqZTCIZu2oVCiA/viewform";
    const MAX_PHOTOS = 30;

    let photos = [];
    let isLevelValid = false;
    let orientationActive = false;

    const video = document.getElementById('video');
    const frame = document.getElementById('frame');
    const startOverlay = document.getElementById('start-overlay');
    const statusText = document.getElementById('status-text');
    const invalidText = document.getElementById('invalid-text');
    const captureBtn = document.getElementById('capture');
    const finishBtn = document.getElementById('finish');
    const canvas = document.getElementById('canvas');
    const flash = document.getElementById('flash');

    // Obtener Order ID de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const etyOrderID = urlParams.get('order') || "MANUAL_" + Math.random().toString(36).substring(2,6).toUpperCase();
    document.getElementById('order-number').innerText = "ORDER ID: " + etyOrderID;

    // AUDIO
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playCameraSound(){
        if(audioCtx.state==='suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.frequency.setValueAtTime(600,audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(10,audioCtx.currentTime+0.1);
        gain.gain.setValueAtTime(0.4,audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.1);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime+0.1);
    }

    // INICIALIZAR CÁMARA
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(s => { video.srcObject = s; if(audioCtx.state==='suspended') audioCtx.resume(); })
        .catch(err => { alert("Camera access is required to continue."); });

    // INICIAR SCANNER
    init-btn.onclick = async () => {
        audioCtx.resume();
        if(!orientationActive){
            if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){
                try { const res = await DeviceOrientationEvent.requestPermission(); if(res==='granted') window.addEventListener('deviceorientation', handleLevel); } catch(e){}
            } else { window.addEventListener('deviceorientation', handleLevel); }
            orientationActive = true;
        }
        startOverlay.style.display='none';
    };

    // NIVELADOR
    function handleLevel(e){
        const tilt = Math.abs(e.beta);
        const side = Math.abs(e.gamma);
        const isWall = tilt>75 && tilt<105 && side<8;
        const isFlat = tilt<10 || tilt>170 && side<10;
        isLevelValid = isWall||isFlat;
        if(isLevelValid){ frame.style.borderColor="#00ff00"; frame.style.borderWidth="6px"; frame.style.boxShadow="0 0 25px #00ff00"; }
        else { frame.style.borderColor="rgba(255,0,0,0.6)"; frame.style.borderWidth="4px"; frame.style.boxShadow="none"; }
    }

    // CAPTURA FOTO
    captureBtn.onclick = () => {
        if(!video.videoWidth) return;
        if(!isLevelValid){
            invalidText.style.display="block"; invalidText.style.opacity="1";
            setTimeout(()=>{ invalidText.style.opacity="0"; setTimeout(()=>{ invalidText.style.display="none"; },500); },2000);
            return;
        }
        if(photos.length>=MAX_PHOTOS){ alert("Maximum "+MAX_PHOTOS+" photos per order."); return; }
        playCameraSound();
        flash.style.opacity="1"; setTimeout(()=>{ flash.style.opacity="0"; },80);
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video,0,0);
        photos.push(canvas.toDataURL('image/jpeg',0.45));
        invalidText.style.display="none";
        statusText.innerText="DEVICE SAVED.\nNEXT ONE!";
        statusText.style.opacity="1";
        setTimeout(()=>{ statusText.style.opacity="0"; },2000);
        finishBtn.style.display="block";
    };

    // FINALIZAR PEDIDO
    finishBtn.onclick = async () => {
        if(!navigator.onLine){ alert("No internet connection detected."); return; }
        if(photos.length===0){ alert("Please capture at least one image before finishing the order."); return; }
        finishBtn.disabled=true;
        document.getElementById('loading').style.display='flex';

        try {
            await fetch(WEBAPP_URL, {
                method:'POST',
                mode:'no-cors',
                body: JSON.stringify({ userName: etyOrderID, photos: photos })
            });

            setTimeout(()=>{ window.location.href = GOOGLE_FORM + "?usp=pp_url&entry.ID_AQUI=" + etyOrderID; },1500);
        } catch(err){
            alert("Network error. Please check your connection.");
            document.getElementById('loading').style.display='none';
            finishBtn.disabled=false;
        }
    };
</script>
</body>
</html>
