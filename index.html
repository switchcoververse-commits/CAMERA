<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Scanner Pro V8.1</title>

<style>
html, body{
margin:0;
padding:0;
height:100%;
background:#000;
font-family:-apple-system, sans-serif;
overflow:hidden;
-webkit-touch-callout:none;
-webkit-user-select:none;
user-select:none;
touch-action:manipulation;
}

.scanner-wrapper{
position:relative;
width:100%;
height:100dvh;
display:flex;
flex-direction:column;
align-items:center;
}

.header{
width:100%;
padding:10px 0;
text-align:center;
z-index:50;
}

.header h2{
margin:0;
font-size:18px;
color:#00d4ff;
letter-spacing:2px;
}

.instructions{
position:relative;
z-index:60;
width:90%;
max-width:400px;
background:#fff;
color:#000;
padding:15px 20px;
border-radius:15px;
margin-bottom:10px;
text-align:center;
}

.instructions button{
margin-top:10px;
padding:12px 25px;
border:none;
border-radius:50px;
background:#00d4ff;
color:#000;
font-weight:900;
font-size:16px;
}

.camera-container{
position:relative;
width:100%;
flex:1;
display:flex;
align-items:center;
justify-content:center;
z-index:10;
}

video{
width:90%;
max-width:500px;
border-radius:20px;
object-fit:cover;
}

.scanner-frame{
position:absolute;
top:50%;
left:50%;
transform:translate(-50%,-50%);
width:75%;
height:55%;
border:4px solid rgba(255,0,0,0.6);
border-radius:25px;
pointer-events:none;
transition:all .2s ease;
}

#flash{
position:absolute;
top:0;
left:0;
width:100%;
height:100%;
background:white;
opacity:0;
z-index:30;
pointer-events:none;
}

.status-text,.invalid-text{
position:absolute;
top:10%;
left:50%;
transform:translateX(-50%);
font-weight:900;
text-align:center;
font-size:22px;
opacity:0;
transition:opacity .6s ease;
z-index:60;
}

.status-text{color:#00ff00;}
.invalid-text{color:#ff3333;}

.controls{
width:100%;
padding:10px 0 calc(10px + env(safe-area-inset-bottom));
display:flex;
justify-content:center;
gap:20px;
z-index:50;
}

.shutter-btn{
width:80px;
height:80px;
background:white;
border-radius:50%;
border:6px solid #333;
}

.btn-finish{
display:none;
padding:12px 30px;
background:#00ff00;
color:#000;
border:none;
font-weight:900;
border-radius:50px;
font-size:16px;
}

.thumbnail-bar{
width:100%;
overflow-x:auto;
display:flex;
gap:8px;
padding:8px;
padding-bottom:calc(8px + env(safe-area-inset-bottom));
background:#000;
}

.thumbnail-bar img{
height:60px;
border-radius:8px;
}

#loading{
display:none;
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,.95);
z-index:1000;
align-items:center;
justify-content:center;
flex-direction:column;
}

.spinner{
width:50px;
height:50px;
border:6px solid #222;
border-top:6px solid #00ff00;
border-radius:50%;
animation:spin 1s linear infinite;
}

@keyframes spin{
0%{transform:rotate(0deg);}
100%{transform:rotate(360deg);}
}
</style>
</head>

<body>

<div class="scanner-wrapper">

<div class="header">
<h2 id="order-display">SCANNER READY</h2>
<p id="order-number"></p>
</div>

<div class="instructions">
<p>Align your device inside the frame and press Start Scanner</p>
<button id="init-btn">START SCANNER</button>
</div>

<div class="camera-container">
<video id="video" autoplay playsinline muted></video>
<div class="scanner-frame" id="frame"></div>
<div id="flash"></div>
<div class="status-text" id="status-text">DEVICE SAVED</div>
<div class="invalid-text" id="invalid-text">NOT LEVEL</div>
</div>

<div class="controls">
<div class="shutter-btn" id="capture"></div>
<button id="finish" class="btn-finish">FINISH ORDER</button>
</div>

<div class="thumbnail-bar" id="thumbs"></div>

</div>

<div id="loading">
<div class="spinner"></div>
<p style="margin-top:20px;color:#00ff00;font-weight:900;">SENDING...</p>
</div>

<script>
const WEBAPP_URL="https://script.google.com/macros/s/AKfycbz0ZGbgeTsKLE4-wUG9sGr7tb2kxPopysqhnkeEloyaL2OShwhuivW4tcy7IlFR5FpX4Q/exec";
const MAX_PHOTOS=30;

let photos=[];
let isLevelValid=false;

const video=document.getElementById("video");
const frame=document.getElementById("frame");
const captureBtn=document.getElementById("capture");
const finishBtn=document.getElementById("finish");
const thumbs=document.getElementById("thumbs");
const statusText=document.getElementById("status-text");
const invalidText=document.getElementById("invalid-text");
const flash=document.getElementById("flash");
const canvas=document.createElement("canvas");

navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
.then(stream=>{video.srcObject=stream;})
.catch(()=>{});

document.getElementById("init-btn").onclick=async()=>{
if(typeof DeviceOrientationEvent!=="undefined" && typeof DeviceOrientationEvent.requestPermission==="function"){
try{
const res=await DeviceOrientationEvent.requestPermission();
if(res==="granted"){window.addEventListener("deviceorientation",handleLevel);}
}catch(e){}
}else{
window.addEventListener("deviceorientation",handleLevel);
}
document.querySelector(".instructions").style.display="none";
};

function handleLevel(e){
if(e.beta===null||e.gamma===null) return;

const tilt=Math.abs(e.beta-90);
const side=Math.abs(e.gamma);

isLevelValid=(tilt<5 && side<5);

if(isLevelValid){
frame.style.borderColor="#00ff00";
frame.style.borderWidth="6px";
}else{
frame.style.borderColor="rgba(255,0,0,0.6)";
frame.style.borderWidth="4px";
}
}

captureBtn.addEventListener("click",e=>{
e.preventDefault();

if(!isLevelValid){
invalidText.style.opacity="1";
setTimeout(()=>invalidText.style.opacity="0",1500);
return;
}

if(photos.length>=MAX_PHOTOS) return;

flash.style.opacity="1";
setTimeout(()=>flash.style.opacity="0",80);

canvas.width=video.videoWidth;
canvas.height=video.videoHeight;
canvas.getContext("2d").drawImage(video,0,0);

const imgData=canvas.toDataURL("image/jpeg",0.6);
photos.push(imgData);

const img=document.createElement("img");
img.src=imgData;
thumbs.appendChild(img);

statusText.style.opacity="1";
setTimeout(()=>statusText.style.opacity="0",1500);

finishBtn.style.display="inline-block";
},{passive:false});

finishBtn.addEventListener("click",async e=>{
e.preventDefault();
if(photos.length===0) return;

finishBtn.disabled=true;
document.getElementById("loading").style.display="flex";

try{
await fetch(WEBAPP_URL,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({photos})
});
}catch(e){}

location.reload();
},{passive:false});
</script>

</body>
</html>
