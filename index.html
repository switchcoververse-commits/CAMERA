<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<style>
html,body{
margin:0;
padding:0;
background:#000;
font-family:-apple-system,sans-serif;
height:100%;
overflow:hidden;
}

.scanner-wrapper{
position:relative;
width:100%;
height:100dvh;
display:flex;
flex-direction:column;
}

.camera-container{
position:relative;
flex:1;
overflow:hidden;
}

video{
position:absolute;
width:100%;
height:100%;
object-fit:cover;
}

.scanner-frame{
position:absolute;
width:80%;
aspect-ratio:4/3;
border:4px solid rgba(255,0,0,0.7);
border-radius:20px;
top:50%;
left:50%;
transform:translate(-50%,-50%);
transition:.25s ease;
pointer-events:none;
}

/* MINIATURAS */
.thumbnail-bar{
position:fixed;
left:0;
right:0;
bottom:calc(110px + env(safe-area-inset-bottom));
display:flex;
gap:10px;
padding:10px;
overflow-x:auto;
background:rgba(0,0,0,.9);
z-index:50;
}

.thumb-wrapper{
position:relative;
flex:0 0 auto;
}

.thumb-wrapper img{
height:75px;
border-radius:10px;
display:block;
}

.delete-btn{
position:absolute;
top:-6px;
right:-6px;
background:red;
color:white;
border:none;
border-radius:50%;
width:22px;
height:22px;
font-size:14px;
line-height:20px;
padding:0;
}

/* CONTROLES */
.controls{
position:fixed;
left:0;
right:0;
bottom:calc(20px + env(safe-area-inset-bottom));
display:flex;
justify-content:center;
gap:20px;
z-index:60;
}

.shutter-btn{
width:75px;
height:75px;
border-radius:50%;
background:white;
border:5px solid #333;
}

.btn-finish{
display:none;
padding:12px 25px;
background:#00ff00;
border:none;
border-radius:40px;
font-weight:700;
}
</style>
</head>

<body>

<div class="scanner-wrapper">

<div class="camera-container">
<video id="video" autoplay playsinline muted></video>
<div class="scanner-frame" id="frame"></div>
</div>

<div class="thumbnail-bar" id="thumbs"></div>

<div class="controls">
<div class="shutter-btn" id="capture"></div>
<button id="finish" class="btn-finish">FINISH ORDER</button>
</div>

</div>

<script>
const video=document.getElementById("video");
const frame=document.getElementById("frame");
const captureBtn=document.getElementById("capture");
const finishBtn=document.getElementById("finish");
const thumbs=document.getElementById("thumbs");

let photos=[];
let isLevelStable=false;

navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
.then(stream=>{video.srcObject=stream;});


// ===== SENSOR PROFESIONAL =====

let greenLock=false;
let greenTimeout=null;
let fx=0, fy=0, fz=0;

const FILTER=0.85;
const THRESHOLD=0.12; // tolerancia paralelismo
const LOCK_TIME=2500;

async function enableMotion(){
if(typeof DeviceMotionEvent !== "undefined" &&
typeof DeviceMotionEvent.requestPermission === "function"){
try{
const permission=await DeviceMotionEvent.requestPermission();
if(permission==="granted"){
window.addEventListener("devicemotion",handleMotion);
}
}catch(e){}
}else{
window.addEventListener("devicemotion",handleMotion);
}
}

function handleMotion(event){
if(!event.accelerationIncludingGravity) return;

let x=event.accelerationIncludingGravity.x;
let y=event.accelerationIncludingGravity.y;
let z=event.accelerationIncludingGravity.z;

let norm=Math.sqrt(x*x+y*y+z*z);
x/=norm; y/=norm; z/=norm;

// FILTRO
fx=fx*FILTER + x*(1-FILTER);
fy=fy*FILTER + y*(1-FILTER);
fz=fz*FILTER + z*(1-FILTER);

// PARALELISMO:
// pared → z cercano a 0
// piso/techo → x,y cercanos a 0

let wallParallel=Math.abs(fz)<THRESHOLD;
let flatParallel=Math.abs(fx)<THRESHOLD && Math.abs(fy)<THRESHOLD;

if(!greenLock && (wallParallel||flatParallel)){

greenLock=true;
isLevelStable=true;

frame.style.borderColor="#00ff00";
frame.style.borderWidth="6px";

greenTimeout=setTimeout(()=>{
greenLock=false;
isLevelStable=false;
frame.style.borderColor="rgba(255,0,0,0.7)";
frame.style.borderWidth="4px";
},LOCK_TIME);

}

if(greenLock && !(wallParallel||flatParallel)){
clearTimeout(greenTimeout);
greenLock=false;
isLevelStable=false;
frame.style.borderColor="rgba(255,0,0,0.7)";
frame.style.borderWidth="4px";
}
}

enableMotion();


// ===== CAPTURA =====

captureBtn.addEventListener("click",e=>{
e.preventDefault();
if(!isLevelStable) return;

const canvas=document.createElement("canvas");
canvas.width=video.videoWidth;
canvas.height=video.videoHeight;
canvas.getContext("2d").drawImage(video,0,0);

const imgData=canvas.toDataURL("image/jpeg",0.7);
photos.push(imgData);

const wrapper=document.createElement("div");
wrapper.className="thumb-wrapper";

const img=document.createElement("img");
img.src=imgData;

const del=document.createElement("button");
del.className="delete-btn";
del.innerText="×";

del.onclick=()=>{
const index=photos.indexOf(imgData);
if(index>-1) photos.splice(index,1);
wrapper.remove();
if(photos.length===0) finishBtn.style.display="none";
};

wrapper.appendChild(img);
wrapper.appendChild(del);
thumbs.appendChild(wrapper);

finishBtn.style.display="inline-block";
});

finishBtn.onclick=()=>{
location.reload();
};
</script>

</body>
</html>
